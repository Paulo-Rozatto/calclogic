<!DOCTYPE html>

<head>
    <title>Logic expressions</title>
    <meta charset="utf8" />
    <style>
        html,
        body {
            margin: 0 auto;
            padding: 0;
            background-color: #AA9;
            height: 100%;
        }
        
        form {
            height: 100%;
            width: auto;
        }
        
        fieldset {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 90%;
            height: 55%;
        }
        
        textarea {
            display: block;
            margin-left: auto;
            margin-right: auto
        }
        
        .container {
            height: 100%;
            padding: 2%;
            margin-left: 10%;
            margin-right: 10%;
            background-color: #66777777;
        }
        
        .text {
            width: 90%;
            height: 37%;
            /* min-height: 100px; */
        }
    </style>
</head>

<body>
    <div class="container">
        <fieldset>
            <legend>Logic expressions</legend>

            <label for="input">Input</label>
            <textarea id="input" class="text" name="input" autofocus> </textarea><br/>

            <label for="output">Output</label>
            <textarea id="output" class="text" name="output" disabled> </textarea><br/>

            <button name="btn-truth" onclick="drawTruthTable()">Truth Table</button>
        </fieldset>
    </div>

    <script type="text/javascript">
        function validateInput(text) {
            let isValid = true;
            const checkInvalidChars = /\w{2,}|[^\w\s\(\)\^~|<>-]|\d/
            const checkInvalidSymbols = /<(?!->)|-(?!>)|[^-]>|^>/
            const parentheses = text.match(/\(|\)/g)
            let ctrl = 0;

            //remove white spaces
            text = text.match(/[^\s]/g).join('')


            printOutput("")
            if (checkInvalidChars.test(text)) {
                printOutput("Ivalid character")
                isValid = false
            } else if (checkInvalidSymbols.test(text)) {
                printOutput("Ivalid symbol")
                isValid = false
            } else if (parentheses) {
                for (let i = 0; i < parentheses.length; i++) {
                    if (parentheses[i] == "(") ctrl++;
                    else if (parentheses[i] == ")") ctrl--;
                    if (ctrl < 0) break;
                }

                if (ctrl != 0) {
                    printOutput("Invalid parentheses")
                    isValid = false;
                }
            }

            return {
                isValid,
                text
            }
        }

        function printOutput(text) {
            const output = document.getElementById("output")
            output.value = text
        }

        function readPropositions(text) {
            const propsKeys = []
            const propositions = []
            text = text.match(/\w/g)

            for (let i = 0; i < text.length; i++) {
                if (!propsKeys.includes(text[i])) {

                    propsKeys.push(text[i])
                }
                propsKeys.sort()
            }
            for (let i = 0; i < propsKeys.length; i++) {
                propositions[i] = propositionFactory(propsKeys[i], i, propsKeys.length)
            }

            return propositions
        }

        function propositionFactory(key, order, numberProps) {
            const values = []
            let cont = 0
            let value = true

            for (let i = 0; i < Math.pow(2, numberProps); i++) {
                if (cont >= Math.pow(2, (numberProps - order - 1))) {
                    value = !value
                    cont = 0
                }
                values[i] = value
                cont++;
            }
            return {
                key,
                values
            }
        }

        function drawTruthTable() {
            let text = document.getElementById("input").value
            const validation = validateInput(text)

            if (!validation.isValid) {
                return null
            }

            text = validation.text
            const propositions = readPropositions(text)
            let output = ""

            for (let i = 0; i < propositions.length; i++) {
                output += `| ${propositions[i].key} `
            }
            output += '|\n'

            for (let i = 0; i < propositions[0].values.length; i++) {
                for (let j = 0; j < propositions.length; j++) {
                    output += `| ${propositions[j].values[i] ? 'T' : 'F'} `
                }
                output += '|\n'
            }

            printOutput(output)
        }
    </script>
</body>
<!DOCTYPE html>

<head>
    <title>Logic expressions</title>
    <meta charset="utf-8" />
    <style>
        html,
        body {
            margin: 0 auto;
            padding: 0;
            background-color: #AA9;
            height: 100%;
        }
        
        form {
            height: 100%;
            width: auto;
        }
        
        fieldset {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 90%;
            height: 55%;
        }
        
        textarea {
            display: block;
            margin-left: auto;
            margin-right: auto;
            font-size: 1.3em;
        }
        
        .container {
            height: 100%;
            padding: 2%;
            margin-left: 10%;
            margin-right: 10%;
            background-color: #66777777;
        }
        
        .text {
            width: 90%;
            height: 37%;
            /* min-height: 100px; */
        }
    </style>
</head>

<body>
    <div class="container">
        <fieldset>
            <legend>Logic expressions</legend>

            <label for="input">Input</label>
            <textarea id="input" class="text" name="input" autofocus> </textarea><br/>

            <label for="output">Output</label>
            <textarea id="output" class="text" name="output" readonly> </textarea><br/>

            <button name="btn-truth" onclick="drawTruthTable()">Truth Table</button>
            <button name="btn-copy" onclick="copyToClipboard()">Copy Output</button>
        </fieldset>
    </div>

    <script type="text/javascript">
        function validateInput(text) {
            let isValid = false;
            const checkInvalidChars = /\w{2,}|[^\w\s\(\)\^~|<>-]|\d/
            const checkInvalidSymbols = /<(?!->)|-(?!>)|[^-]>|^>/
            const parentheses = text.match(/\(|\)/g)
            let ctrl = 0;


            printOutput("")

            //remove white spaces
            text = text.match(/[^\s]/g)
            if (text) {
                text = text.join('')
                isValid = true

                if (checkInvalidChars.test(text)) {
                    printOutput("Ivalid character")
                    isValid = false
                } else if (checkInvalidSymbols.test(text)) {
                    printOutput("Ivalid symbol")
                    isValid = false
                } else if (parentheses) {
                    for (let i = 0; i < parentheses.length; i++) {
                        if (parentheses[i] == "(") ctrl++;
                        else if (parentheses[i] == ")") ctrl--;
                        if (ctrl < 0) break;
                    }

                    if (ctrl != 0) {
                        printOutput("Invalid parentheses")
                        isValid = false;
                    }
                }
            }

            return {
                isValid,
                text
            }
        }

        function printOutput(text) {
            const output = document.getElementById("output")
            output.value = text
        }

        function readPropositions(text) {
            const propsKeys = []
            const propositions = []
            text = text.match(/\w/g)

            for (let i = 0; i < text.length; i++) {
                if (!propsKeys.includes(text[i])) {

                    propsKeys.push(text[i])
                }
            }
            propsKeys.sort()
            for (let i = 0; i < propsKeys.length; i++) {
                propositions[i] = propositionFactory(propsKeys[i], i, propsKeys.length)
            }

            return propositions
        }

        function propositionFactory(key, order, numberProps) {
            const values = []
            let cont = 0
            let value = true

            if (arguments.length == 0) {
                if (typeof propositionFactory.autoId == 'undefined') {
                    propositionFactory.autoId = 0
                }
                propositionFactory.autoId++
                    return {
                        key: propositionFactory.autoId,
                        values: [],
                        desc: ""
                    }
            }

            for (let i = 0; i < Math.pow(2, numberProps); i++) {
                if (cont >= Math.pow(2, (numberProps - order - 1))) {
                    value = !value
                    cont = 0
                }
                values[i] = value
                cont++;
            }
            return {
                key,
                values
            }
        }

        function findParentheses(text, propositions) {
            const parenRegex = /\((.+)\)/
            let parenMatch

            while ((parenMatch = text.match(parenRegex)) != null) {
                let parenValue = findParentheses(parenMatch[1], propositions)
                const newProp = propositionFactory()

                newProp.values = parenValue
                newProp.desc = parenMatch[1]
                propositions.push(newProp)
                text = text.replace(parenMatch[0], newProp.key)
            }
            return composeProps(text, propositions)
        }

        function composeProps(text, propositions) {
            let index
            const negRegex = /~/g

            text = text.replace(/<->/g, "<")
            text = text.replace(/->/g, ">")

            text = text.match(/[a-z]|[\d]+|[<>|\^~]/g)

            for (let i = 0; i < text.length; i++) {
                let prop = propositions.find(p => p.key == text[i])
                if (prop) text[i] = [...prop.values]
            }

            while ((index = text.indexOf("~")) != -1) {

                for (let i = 0; i < text[index + 1].length; i++) {
                    text[index + 1][i] = !text[index + 1][i]
                }
                text.splice(index, 1)

            }

            while ((index = text.indexOf("^")) != -1) {

                for (let i = 0; i < text[index + 1].length; i++) {
                    text[index + 1][i] = text[index + 1][i] && text[index - 1][i]
                }
                text.splice(index - 1, 2)

            }

            while ((index = text.indexOf("|")) != -1) {

                for (let i = 0; i < text[index + 1].length; i++) {
                    text[index + 1][i] = text[index + 1][i] || text[index - 1][i]
                }
                text.splice(index - 1, 2)

            }

            while ((index = text.indexOf(">")) != -1) {

                for (let i = 0; i < text[index + 1].length; i++) {
                    text[index + 1][i] = (!text[index - 1][i] || text[index + 1][i])
                }
                text.splice(index - 1, 2)

            }

            while ((index = text.indexOf("<")) != -1) {

                for (let i = 0; i < text[index + 1].length; i++) {
                    text[index + 1][i] = (!text[index + 1][i] || text[index - 1][i]) && (text[index + 1][i] || !text[index - 1][i])
                }
                text.splice(index - 1, 2)

            }

            return text[0]
        }

        function drawTruthTable() {
            let text = document.getElementById("input").value
            const validation = validateInput(text)

            if (!validation.isValid) {
                return null
            }

            text = validation.text
            const propositions = readPropositions(text)
            let output = ""

            const result = findParentheses(text, propositions)

            for (let i = 0; i < propositions.length; i++) {
                if (propositions[i].desc) {
                    output += `| ${propositions[i].desc} `
                } else {
                    output += `| ${propositions[i].key} `
                }
            }
            output += `| ${text}\n`

            for (let i = 0; i < propositions[0].values.length; i++) {
                for (let j = 0; j < propositions.length; j++) {
                    output += `| ${propositions[j].values[i] ? 'T' : 'F'}${propositions[j].desc ? ' '.repeat(propositions[j].desc.length): ' '}`
                }
                output += `| ${result[i] ? 'T' : 'F'}\n`
            }

            printOutput(output)
        }

        function copyToClipboard() {
            const copyText = document.getElementById("output");

            copyText.select();
            copyText.setSelectionRange(0, 99999); /*For mobile devices*/
            document.getSelection().removeAllRanges()
            copyText.selectionEnd = copyText.selectionStart

            document.execCommand("copy");
        }
    </script>
</body>